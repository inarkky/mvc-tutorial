<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Basic security</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">1.</strong> Intro</a></li><li class="chapter-item expanded "><a href="chapter_2.html"><strong aria-hidden="true">2.</strong> Structure</a></li><li class="chapter-item expanded "><a href="chapter_3.html"><strong aria-hidden="true">3.</strong> Bare bones</a></li><li class="chapter-item expanded "><a href="chapter_4.html"><strong aria-hidden="true">4.</strong> First app</a></li><li class="chapter-item expanded "><a href="chapter_5.html" class="active"><strong aria-hidden="true">5.</strong> Basic security</a></li><li class="chapter-item expanded "><a href="chapter_6.html"><strong aria-hidden="true">6.</strong> Cookies and sessions</a></li><li class="chapter-item expanded "><a href="chapter_7.html"><strong aria-hidden="true">7.</strong> Database</a></li><li class="chapter-item expanded "><a href="chapter_8.html"><strong aria-hidden="true">8.</strong> Recap</a></li><li class="chapter-item expanded "><a href="chapter_9.html"><strong aria-hidden="true">9.</strong> File handling</a></li><li class="chapter-item expanded "><a href="chapter_10.html"><strong aria-hidden="true">10.</strong> Localization</a></li><li class="chapter-item expanded "><a href="chapter_11.html"><strong aria-hidden="true">11.</strong> Templating</a></li><li class="chapter-item expanded "><a href="chapter_12.html"><strong aria-hidden="true">12.</strong> Second App</a></li><li class="chapter-item expanded "><a href="chapter_13.html"><strong aria-hidden="true">13.</strong> Emails</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#chapter-5---basic-security" id="chapter-5---basic-security">Chapter 5 - Basic security</a></h1>
<p>I have told you before that this framework will not be of a production grade quality, but that does not mean we should leave the security holes wide open. In this chapter we will make three new classes that will hopefully make this framework more secure. And first class we'll be covering is request helper. So create a new folder &quot;helpers&quot; in our <code>/application/</code> directory and put in it a new file &quot;Request.php&quot;.</p>
<pre><code class="language-php">&lt;?php

namespace application\helpers;


class Request 
{

}

</code></pre>
<p>This class will consist of three parts. First is gonna be so called checkers part that we can use to get informations about the request so let's add those methods in our Request.php file.</p>
<pre><code class="language-php">//returns protocol used for by the request
public static function protocol() {
    $secure = (self::server('HTTP_HOST') &amp;&amp; self::server('HTTPS') &amp;&amp; strtolower(self::server('HTTPS')) !== 'off');

    return $secure ? 'https' : 'http';
}

//check if the request is sent via ajax function
public static function isAjax() {
    return (self::server('HTTP_X_REQUESTED_WITH') &amp;&amp; strtolower(self::server('HTTP_X_REQUESTED_WITH')) === 'xmlhttprequest');
}

//determains which method is used to send a request
public static function method($upper = true) {
    $method = self::server('REQUEST_METHOD');

    return $upper ? strtoupper($method) : strtolower($method);
}

//and finally we can check the referer header if we need to
public static function referrer($default = null) {
    $referrer = self::server('HTTP_REFERER', $default);

    if ($referrer === null &amp;&amp; $default !== null) {
        $referrer = $default;
    }

    return $referrer;
}
</code></pre>
<p>Now those methods are just used to check something, they don't actually parse the request. To do so we first need to sanatize it, so let's also add the function that will do just that.</p>
<pre><code class="language-php">public static function xssClean($str = '') {
    // No data? We're done here
    if (is_string($str) &amp;&amp; trim($str) === '') {
        return $str;
    }

    // Recursive sanitize if this is an array
    if (is_array($str)) {
        foreach ($str as $key =&gt; $value) {
            $str[$key] = self::xssClean($value);
        }

        return $str;
    }

    $str = str_replace(array(
        '&amp;amp;',
        '&amp;lt;',
        '&amp;gt;'
    ), array(
        '&amp;amp;amp;',
        '&amp;amp;lt;',
        '&amp;amp;gt;'
    ), $str);

    // Fix &amp;entitiy\n;
    $str = preg_replace('#(&amp;\#*\w+)[\x00-\x20]+;#u', '$1;', $str);
    $str = preg_replace('#(&amp;\#x*)([0-9A-F]+);*#iu', '$1$2;', $str);
    $str = html_entity_decode($str, ENT_COMPAT, 'UTF-8');

    // remove any attribute starting with &quot;on&quot; or xmlns
    $str = preg_replace('#(&lt;[^&gt;]+[\x00-\x20\&quot;\'\/])(on|xmlns)[^&gt;]*&gt;#iUu', '$1&gt;', $str);

    // remove javascript
    $str = preg_replace('#([a-z]*)[\x00-\x20\/]*=[\x00-\x20\/]*([\`\'\&quot;]*)[\x00-\x20\/]*j[\x00-\x20]*a[\x00-\x20]*v[\x00-\x20]*a[\x00-\x20]*s[\x00-\x20]*c[\x00-\x20]*r[\x00-\x20]*i[\x00-\x20]*p[\x00-\x20]*t[\x00-\x20]*:#iUu', '$1=$2nojavascript...', $str);
    $str = preg_replace('#([a-z]*)[\x00-\x20\/]*=[\x00-\x20\/]*([\`\'\&quot;]*)[\x00-\x20\/]*v[\x00-\x20]*b[\x00-\x20]*s[\x00-\x20]*c[\x00-\x20]*r[\x00-\x20]*i[\x00-\x20]*p[\x00-\x20]*t[\x00-\x20]*:#iUu', '$1=$2novbscript...', $str);
    $str = preg_replace('#([a-z]*)[\x00-\x20\/]*=[\x00-\x20\/]*([\`\'\&quot;]*)[\x00-\x20\/]*-moz-binding[\x00-\x20]*:#Uu', '$1=$2nomozbinding...', $str);
    $str = preg_replace('#([a-z]*)[\x00-\x20\/]*=[\x00-\x20\/]*([\`\'\&quot;]*)[\x00-\x20\/]*data[\x00-\x20]*:#Uu', '$1=$2nodata...', $str);

    // Remove any style attributes, IE allows too much stupid things in them
    $str = preg_replace('#(&lt;[^&gt;]+[\x00-\x20\&quot;\'\/])style[^&gt;]*&gt;#iUu', '$1&gt;', $str);

    // Remove namespaced elements
    $str = preg_replace('#&lt;/*\w+:\w[^&gt;]*&gt;#i', '', $str);

    // Remove really unwanted tags
    do {
        $oldstring = $str;
        $str = preg_replace('#&lt;/*(applet|meta|xml|blink|link|style|script|embed|object|iframe|frame|frameset|ilayer|layer|bgsound|title|base)[^&gt;]*&gt;#i', '', $str);
    }
    while ($oldstring !== $str);

    return $str;
}
</code></pre>
<p>Now every time we need to get data from the request we'll need to run it through xssClean function, but doing so is easy to forget so lets add some wrapper methods to help us with that.</p>
<pre><code class="language-php">//check if something exists in request payload
private static function _findFromArray($array = array(), $item = '', $default = null, $xss_clean = true) {
    if (empty($array)) {
        return $default;
    }

    if ( ! $item) {
        $arr = array();
        foreach (array_keys($array) as $key) {
            $arr[$key] = self::_fetchFromArray($array, $key, $default, $xss_clean);
        }
        return $arr;
    }

    return self::_fetchFromArray($array, $item, $default, $xss_clean);
}

//if it exists, fetch it
private static function _fetchFromArray($array, $item = '', $default = null, $xss_clean = true) {
    if ( ! isset($array[$item])) {
        return $default;
    }

    if ($xss_clean) {
        return self::xssClean($array[$item]);
    }

    return $array[$item];
}
</code></pre>
<p>Now we have wrappers that will make sure we always sanatize request payload before we use them. But it looks ugly and it's not really intuitive, so let's also add the layer of abstraction over it so when we use it we know, on glance, what it's used for.</p>
<pre><code class="language-php">public static function server($index = '', $default = null) {
    return self::_findFromArray($_SERVER, $index, $default, false);
}

public static function get($item = null, $default = null, $xss_clean = true) {
    return self::_findFromArray($_GET, $item, $default, $xss_clean);
}

public static function post($item = null, $default = null, $xss_clean = true) {
    return self::_findFromArray($_POST, $item, $default, $xss_clean);
}

public static function request($item = null, $default = null, $xss_clean = true) {
    $request = array_merge($_GET, $_POST);

    return self::_findFromArray($request, $item, $default, $xss_clean);
}

public static function file($item = null, $default = null) {
    // If a file field was submitted without a file selected, this may still return a value.
    // It is best to use this method along with Input::hasFile()
    return self::_findFromArray($_FILES, $item, $default, false);
}
</code></pre>
<p>We can do an even higher level of abstraction if we want. In fact, let's do it, just to make things easier for us later on.</p>
<pre><code class="language-php">public static function inGet($item = null) {
    return self::get($item, null, false) !== null;
}

public static function inPost($item = null) {
    return self::post($item, null, false) !== null;
}

public static function inRequest($item = null) {
    return self::request($item, null, false) !== null;
}

public static function inFile($item = null) {
    return self::file($item) !== null;
}

public static function hasFile($item = null) {
    $file = self::file($item);

    return ($file !== null &amp;&amp; $file['tmp_name'] !== '');
}
</code></pre>
<p>And that is it for the request helper. Now we can patch some earlier vulnerabilities. Edit the file <code>/application/core/Router.php</code> like this:</p>
<pre><code class="language-php">&lt;?php

namespace application\core;

use View;
use application\helpers\Request;

class Router 
{

    protected $routes = [];
    protected $params = [];
    
    public function __construct() 
    {
        $arr = require 'application/config/routes.php';
        foreach ($arr as $key =&gt; $val) {
            $this-&gt;add($key, $val);
        }
    }

    public function add($route, $params) 
    {
        $route = parse_url($route, PHP_URL_PATH);
        $route = '#^'.$route.'$#';
        $this-&gt;routes[$route] = $params;
    }

    public function match() 
    {
        $url = parse_url(trim(Request::server('REQUEST_URI'), ROOT_URI_PATH), PHP_URL_PATH);

        foreach ($this-&gt;routes as $route =&gt; $params) {
            if (preg_match($route, $url, $matches)) {
                $this-&gt;params = $params;
                return true;
            }
        }
        return false;
    }

    public function run()
    {
        if ($this-&gt;match()) {
            $path = 'application\controllers\\'.ucfirst($this-&gt;params['controller']).'Controller';
            if (class_exists($path)) {
                $action = $this-&gt;params['action'].'Action';
                if (method_exists($path, $action)) {
                    $controller = new $path($this-&gt;params);
                    $controller-&gt;$action();
                } else {
                    View::errorCode(500);
                }
            } else {
                View::errorCode(400);
            }
        } else {
            View::errorCode(404);
        }
    }

}
</code></pre>
<p>We can also put the <code>use application\helpers\Request;</code> in the <code>/application/core/Model.php</code> so it look like this:</p>
<pre><code class="language-php">&lt;?php

namespace application\core;


use application\helpers\Request;

abstract class Model 
{	

}
</code></pre>
<p>The next file we are going to make will be focused on protection against csrf attacks so create a file <code>/application/helpers/CSRF.php</code></p>
<pre><code class="language-php">&lt;?php

namespace application\helpers;


use Request;

class CSRF
{
    public static $name = '_CSRF';

    public function __construct()
    {
        session_start(); //later we will need to make sessions a bit more secure also
    }

    public function insert($form = 'default')
    {
        echo '&lt;input type=&quot;hidden&quot; name=&quot;csrf_token&quot; value=&quot;' . $this-&gt;generate($form) . '&quot;&gt;';
    }


    public function generate($form = NULL)
    {
        $token = self::token() . self::fingerprint();
        $_SESSION[self::$name . '_' . $form] = $token;
        return $token;
    }

    public function check($token, $form = NULL)
    {
         if( isset($_SESSION[self::$name . '_' . $form]) &amp;&amp; $_SESSION[self::$name . '_' . $form] == $token){ //token OK
            return (substr($token, -32) === self::fingerprint()); // fingerprint OK?
        }
        return FALSE;
    }

    protected static function token()
    {
        mt_srand((double) microtime() * 10000);
        $charid = strtoupper(md5(uniqid(rand(), TRUE)));
        return substr($charid, 0, 8) .
               substr($charid, 8, 4) .
               substr($charid, 12, 4) .
               substr($charid, 16, 4) .
               substr($charid, 20, 12);
    }

    protected static function fingerprint()
    {
        return strtoupper(md5(implode('|', array(Request::server('REMOTE_ADDR'), Request::server('HTTP_USER_AGENT')))));
    }
}
</code></pre>
<p>That was a relatively simple class, what it does is basicly generating and checking the csrf token when forms are sent. Let's add that to our view core class so that it always has csrf token ready if we need to create form in the future. Edit the <code>/application/core/View.php</code></p>
<pre><code class="language-php">&lt;?php

namespace application\core;


use application\helpers\CSRF;

class View 
{

	public $path;
	public $route;
	public $layout;

	public function __construct($route, $layout=LAYOUT) 
	{
		$this-&gt;route = $route;
		$this-&gt;layout = $layout;
		$this-&gt;path = $route['controller'].'/'.$route['action'];
	}

	public function render($vars = []) 
	{
		$csrf = new CSRF(); // create a new csrf object so we can use it to generate tokens on the fly
		extract($vars);
		$path = VIEW_PATH . $this-&gt;path. '.php';
		if (file_exists($path)) {
			ob_start();
			require $path;
			$content = ob_get_clean();
			require PUBLIC_PATH . '/layouts/'.$this-&gt;layout.'.php';
		}
	}

	public static function errorCode($code) 
	{
		http_response_code($code);
		$path = PUBLIC_PATH . '/errors/'.$code.'.php';
		if (file_exists($path)) {
			require $path;
		}
		exit;
	}

    public function redirect($url)
    {
        header('location: '.$url);
        exit;
    }
}	
</code></pre>
<p>And with that we are done with csrf helper class. The last class we are going to make in this chapter is a validation helper class. So create yet another in <code>/application/helpers/</code> and name it Validation.php. This will be a relativly long file, but all it holds is a list of definitions for the rules we are going to use when we get to validate user input. It is worth noting that is not a be all end all list of validators, if you think your app will need some additional definitions then by all means add them. But for the course of this tutorial theese should be enough. </p>
<pre><code class="language-php">&lt;?php

namespace application\helpers;


class Validation {

	public static function checkLength($value, $maxLength, $minLength = 0) 
	{
		if (!(strlen($value) &gt; $maxLength) &amp;&amp; !(strlen($value) &lt; $minLength)) {
			return true;
		} else {
			return false;
		}
	}

	public static function compare($value1, $value2, $caseSensitive = false) 
	{
		if ($caseSensitive) {
			return ($value1 == $value2 ? true : false);
		} else {
			if (strtoupper($value1) == strtoupper($value2)) {
				return true;
			} else {
				return false;
			}
		}
	}

	public static function contains($string, $find, $caseSensitive = true) 
	{
		if (strlen($find) == 0) {
			return true;
		} else {
			if ($caseSensitive) {
				return (strpos($string, $find) !== false);
			} else {
				return (strpos(strtoupper($string), strtoupper($find)) !== false);
			}
		}
	}

	public static function convertToDate($date, $timezone = TIMEZONE, $forceFixDate = true) 
	{
		if ($date instanceof DateTime) {
			return $date;
		} else {
			date_default_timezone_set($timezone);

			$timestamp = strtotime($date);

			if ($timestamp) {
				$date = DateTime::createFromFormat('U', $timestamp);
			} else {
				$date = false;
			}

			return $date;
		}
	}

	public static function getAge($dob, $timezone = TIMEZONE) 
	{
		$date     = self::convertToDate($dob, $timezone);
		$now      = new DateTime();
		$interval = $now-&gt;diff($date);
		return $interval-&gt;y;
	}

	public static function getDefaultOnEmpty($value, $default) 
	{
		if (self::hasValue($value)) {
			return $value;
		} else {
			return $default;
		}
	}

	public static function hasArrayKeys($array, $required_keys, $keys_case = false) 
	{
		$valid = true;
		if (!is_array($array)) {
			$valid = false;
		} else {
			foreach ($required_keys as $key) {
				if ($keys_case == CASE_UPPER) {
					if (!array_key_exists(strtoupper($key), $array)) {
						$valid = false;
					}
				} elseif ($keys_case == CASE_LOWER) {
					if (!array_key_exists(strtolower($key), $array)) {
						$valid = false;
					}
				} else {
					if (!array_key_exists($key, $array)) {
						$valid = false;
					}
				}
			}
		}
		return $valid;
	}

	public static function hasValue($value) 
	{
		return !(self::isEmpty($value));
	}

	public static function isOfAge($age, $legal = 18) 
	{
		return self::getAge($age) &lt; $legal ? false : true;
	}

	public static function isAlpha($value, $allow = '') 
	{
		if (preg_match('/^[a-zA-Z' . $allow . ']+$/', $value)) {
			return true;
		} else {
			return false;
		}
	}

	public static function isAlphaNumeric($value) 
	{
		if (preg_match('/^[A-Za-z0-9 ]+$/', $value)) {
			return true;
		} else {
			return false;
		}
	}

	public static function isEmail($email) 
	{
		$pattern = '/^([a-zA-Z0-9])+([\.a-zA-Z0-9_-])*@([a-zA-Z0-9_-])+(\.[a-zA-Z0-9_-]+)+/';

		if (preg_match($pattern, $email)) {
			return true;
		} else {
			return false;
		}
	}

	public static function isEmpty($value) 
	{
		if (!isset($value)) {
			return true;
		} elseif (is_null($value)) {
			return true;
		} elseif (is_string($value) &amp;&amp; strlen($value) == 0) {
			return true;
		} elseif (is_array($value) &amp;&amp; count($value) == 0) {
			return true;
		} else {
			return false;
		}
	}

	public static function isFloat($number) 
	{
		if (is_float($number)) {
			return true;
		} else {
			$pattern = '/^[-+]?(((\\\\d+)\\\\.?(\\\\d+)?)|\\\\.\\\\d+)([eE]?[+-]?\\\\d+)?$/';
    		return (!is_bool($number) &amp;&amp;
				(is_float($number) || preg_match($pattern, trim($number))));
		}
	}

	public static function isInternetURL($value) 
	{
		if (preg_match('/^http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&amp;=]*)?$/i', $value)) {
			return true;
		} else {
			return false;
		}
	}

	public static function isNumber($number) 
	{
		if (preg_match('/^\-?\+?[0-9e1-9]+$/', $number)) {
			return true;
		} else {
			return false;
		}
	}

	public static function isTooLong($value, $maximumLength) 
	{
		if (strlen($value) &gt; $maximumLength) {
			return true;
		} else {
			return false;
		}
	}

	public static function isTooShort($value, $minimumLength) 
	{
		if (strlen($value) &lt; $minimumLength) {
			return true;
		} else {
			return false;
		}
	}

	public static function isValidCreditCardNumber($cardnumber) 
	{
		$number    = preg_replace('/[^0-9]/i', '', $cardnumber);
		$length    = strlen($number);
		$revNumber = strrev($number);

		// calculate checksum
		$sum       = '';
		for ($i = 0; $i &lt; $length; $i++) {
			$sum .= $i &amp; 1 ? $revNumber[$i] * 2 : $revNumber[$i];
		}

		return array_sum(str_split($sum)) % 10 === 0;
	}

	public static function isValidJSON($string) 
	{
		@json_decode($string);
		return (json_last_error() == JSON_ERROR_NONE);
	}

	public static function sanitize($input) 
	{
		$search = array(
			'@&lt;script[^&gt;]*?&gt;.*?&lt;/script&gt;@si',   // Strip out javascript
			'@&lt;[\/\!]*?[^&lt;&gt;]*?&gt;@si',            // Strip out HTML tags
			'@&lt;style[^&gt;]*?&gt;.*?&lt;/style&gt;@siU',    // Strip style tags properly
			'@&lt;![\s\S]*?--[ \t\n\r]*&gt;@'         // Strip multi-line comments
		);
		return preg_replace($search, '', $input);
	}

	public static function stripExcessWhitespace($string) 
	{
		return preg_replace('/  +/', ' ', $string);
	}

	public static function stripNonAlpha($string) 
	{
		return preg_replace('/[^a-z]/i', '', $string);
	}

	public static function stripNonAlphaHyphenSpaces($string) 
	{
		return preg_replace('/[^a-z\- ]/i', '', $string);
	}

	public static function stripNonAlphaNumeric($string) 
	{
		return preg_replace('/[^a-z0-9]/i', '', $string);
	}

	public static function stripNonAlphaNumericHyphenSpaces($string) 
	{
		return preg_replace('/[^a-z0-9\- ]/i', '', $string);
	}

	public static function stripNonAlphaNumericSpaces($string) 
	{
		return preg_replace('/[^a-z0-9 ]/i', '', $string);
	}

	public static function stripNonNumeric($string) 
	{
		return preg_replace('/[^0-9]/', '', $string);
	}

	public static function trim($value, $mask = ' ') 
	{
		if (is_string($value)) {
			return trim($value, $mask);
		} elseif (is_null($value)) {
			return '';
		} else {
			return $value;
		}
	}

	public static function truncate($string, $length, $dots = '') 
	{
		if (strlen($string) &gt; $length) {
			return substr($string, 0, $length - strlen($dots)) . $dots;
		} else {
			return $string;
		}
	}

	public static function truncateDecimal($float, $precision = 0) 
	{
		$pow     = pow(10, $precision);
		$precise = (int) ($float * $pow);
		return (float) ($precise / $pow);
	}
}
</code></pre>
<p>We could also use some abstraction if the data we are going to validate needs to pass multiple checks. For example if we are going to validate password we could also add this:</p>
<pre><code class="language-php">public static function validatePassword($password, $confirm, $email = '', $username = '', $forceUpperLower = false) 
{

	$problem = '';

	if ($password != $confirm) {
		$problem .= 'Password and confirm password fields did not match.' . &quot;&lt;br&gt;\n&quot;;
	}
	if (strlen($password) &lt; 8) {
		$problem .= 'Password must be at least 8 characters long.' . &quot;&lt;br&gt;\n&quot;;
	}
	if ($email) {
		if (strpos(strtoupper($password), strtoupper($email)) !== false
			|| strpos(strtoupper($password), strtoupper(strrev($email))) !== false) {
			$problem .= 'Password cannot contain the email address.' . &quot;&lt;br&gt;\n&quot;;
		}
	}
	if ($username) {
		if (strpos(strtoupper($password), strtoupper($username)) !== false
			|| strpos(strtoupper($password), strtoupper(strrev($username))) !== false) {
			$problem .= 'Password cannot contain the username (or reversed username).' . &quot;&lt;br&gt;\n&quot;;
		}
	}
	if (!preg_match('#[0-9]+#', $password)) {
		$problem .= 'Password must contain at least one number.' . &quot;&lt;br&gt;\n&quot;;
	}
	if ($forceUpperLower) {
		if (!preg_match('#[a-z]+#', $password)) {
			$problem .= 'Password must contain at least one lowercase letter.' . &quot;&lt;br&gt;\n&quot;;
		}
		if (!preg_match('#[A-Z]+#', $password)) {
			$problem .= 'Password must contain at least one uppercase letter.' . &quot;&lt;br&gt;\n&quot;;
		}
	} else {
		if (!preg_match('#[a-zA-Z]+#', $password)) {
			$problem .= 'Password must contain at least one letter.' . &quot;&lt;br&gt;\n&quot;;
		}
	}

	if (strlen($problem) == 0) {
		$problem = false;
	} else ($returnArray) {
		$problem = explode(&quot;&lt;br&gt;\n&quot;, trim($problem, &quot;&lt;br&gt;\n&quot;));
	}

	return $problem;
}
</code></pre>
<p>And that is all for this chapter. Soon we will integrate database support and so we can start create some more interesting examples, but before that we will need to secure our sessions a bit. So that is what we'll do in the next chapter.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="chapter_4.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="chapter_6.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="chapter_4.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="chapter_6.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
