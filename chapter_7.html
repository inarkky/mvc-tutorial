<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Database</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">1.</strong> Intro</a></li><li class="chapter-item expanded "><a href="chapter_2.html"><strong aria-hidden="true">2.</strong> Structure</a></li><li class="chapter-item expanded "><a href="chapter_3.html"><strong aria-hidden="true">3.</strong> Bare bones</a></li><li class="chapter-item expanded "><a href="chapter_4.html"><strong aria-hidden="true">4.</strong> First app</a></li><li class="chapter-item expanded "><a href="chapter_5.html"><strong aria-hidden="true">5.</strong> Basic security</a></li><li class="chapter-item expanded "><a href="chapter_6.html"><strong aria-hidden="true">6.</strong> Cookies and sessions</a></li><li class="chapter-item expanded "><a href="chapter_7.html" class="active"><strong aria-hidden="true">7.</strong> Database</a></li><li class="chapter-item expanded "><a href="chapter_8.html"><strong aria-hidden="true">8.</strong> Recap</a></li><li class="chapter-item expanded "><a href="chapter_9.html"><strong aria-hidden="true">9.</strong> File handling</a></li><li class="chapter-item expanded "><a href="chapter_10.html"><strong aria-hidden="true">10.</strong> Localization</a></li><li class="chapter-item expanded "><a href="chapter_11.html"><strong aria-hidden="true">11.</strong> Templating</a></li><li class="chapter-item expanded "><a href="chapter_12.html"><strong aria-hidden="true">12.</strong> Second App</a></li><li class="chapter-item expanded "><a href="chapter_13.html"><strong aria-hidden="true">13.</strong> Emails</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#chapter-7---databases" id="chapter-7---databases">Chapter 7 - Databases</a></h1>
<p>Now we have finally come to the part where we get to play with the databases. For the course of the tutorial I will use PDO as an abstraction layer because we might not always want to use mysql as our database, and I want to do this as modular as possible. So first we want to add next part of code to our config.php</p>
<pre><code class="language-php">//DATABASES
define ('CONNECTIONS', [
    'DEFAULT' =&gt; [
        'DB_TYPE' =&gt; 'mysql',
        'DB_HOST' =&gt; '127.0.0.1',
        'DB_PORT' =&gt; '3306',
        'DB_NAME' =&gt; 'mvc',
        'DB_USER' =&gt; 'mvcuser',
        'DB_PASS' =&gt; 'mvcpassword',
        'DB_CHARSET' =&gt; 'utf8'
    ],
]
</code></pre>
<p>As you can see, we will be defining our database in a multidim array so if you ever find yourself in need of handling mltiple databases simultaneously just add them to the list.<br />
Now that we have set up the defaults it's time for us to create our database handler, so create file &quot;DB.php&quot; inside of <code>/application/helpers/</code></p>
<pre><code class="language-php">&lt;?php

namespace application\helpers;


use PDO;

class DB extends PDO
{

    protected static $instances = array();

    public static function connect($connection = 'DEFAULT')
    {
    		//if database is not explicitly set use default (from config.php)
        ($connection === 'DEFAULT') ? $db = CONNECTIONS['DEFAULT'] : $db = CONNECTIONS[$connection];
        if($db === NULL) die(&quot;Connection '$connection' is not defined&quot;);

        $type = $db['DB_TYPE'];
        $host = $db['DB_HOST'];
        $name = $db['DB_NAME'];
        $user = $db['DB_USER'];
        $pass = $db['DB_PASS'];

        $id = &quot;$type.$host.$name.$user.$pass&quot;;

		//don't create new instance if one is already running
		//if you need more, create new object 
        if (isset(self::$instances[$id])) {
            return self::$instances[$id];
        }

		//create a connection
        $instance = new DB(&quot;$type:host=$host;dbname=$name;charset=utf8&quot;, $user, $pass);
        $instance-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

        self::$instances[$id] = $instance;

        return $instance;
    }
}
</code></pre>
<p>Next we are gonna make method for selecting data from the database</p>
<pre><code class="language-php">public function select($sql, $array = array(), $fetchMode = PDO::FETCH_OBJ, $class = '', $single = null)
{
    if (stripos($sql, 'select ') !== 0) {
        $sql = 'SELECT ' . $sql;
    }
    $stmt = $this-&gt;prepare($sql);
    foreach ($array as $key =&gt; $value) {
        if (is_int($value)) {
            $stmt-&gt;bindValue(&quot;$key&quot;, $value, PDO::PARAM_INT);
        } else {
            $stmt-&gt;bindValue(&quot;$key&quot;, $value);
        }
    }
    $stmt-&gt;execute();
    if ($single === null) {
        return $fetchMode === PDO::FETCH_CLASS ? $stmt-&gt;fetchAll($fetchMode, $class) : $stmt-&gt;fetchAll($fetchMode);
    }

    return $fetchMode === PDO::FETCH_CLASS ? $stmt-&gt;fetch($fetchMode, $class) : $stmt-&gt;fetch($fetchMode);
}
</code></pre>
<p>We can also abstract it by adding methods for specific selects like a</p>
<pre><code class="language-php">//select only single row
public function find($sql, $array = array(), $fetchMode = PDO::FETCH_OBJ, $class = '')
{
    return $this-&gt;select($sql, $array, $fetchMode, $class, true);
}

//select only row count
public function count($table, $column= 'id')
{
    $stmt = $this-&gt;prepare(&quot;SELECT $column FROM $table&quot;);
    $stmt-&gt;execute();
    return $stmt-&gt;rowCount();
}
</code></pre>
<p>Following this logic, insert method would look like this:</p>
<pre><code>//table is table name
//data is an assoc array where keys are field names, and values are data we want to insert
public function insert($table, $data)
{
    ksort($data);
    $fieldNames = implode(',', array_keys($data));
    $fieldValues = ':'.implode(', :', array_keys($data));
    $stmt = $this-&gt;prepare(&quot;INSERT INTO $table ($fieldNames) VALUES ($fieldValues)&quot;);
    foreach ($data as $key =&gt; $value) {
        $stmt-&gt;bindValue(&quot;:$key&quot;, $value);
    }
    $stmt-&gt;execute();
    return $this-&gt;lastInsertId();
}
</code></pre>
<p>And with that we practically insured that we will always use prepared statements, and amount of code we would be writing is as minimized as it can be because of the abstraction. Let's do that for the update function as well.</p>
<pre><code class="language-php">public function update($table, $data, $where)
{
    ksort($data);
    $fieldDetails = null;
    foreach ($data as $key =&gt; $value) {
        $fieldDetails .= &quot;$key = :$key,&quot;;
    }
    $fieldDetails = rtrim($fieldDetails, ',');
    $whereDetails = null;
    $i = 0;
    foreach ($where as $key =&gt; $value) {
        if ($i == 0) {
            $whereDetails .= &quot;$key = :$key&quot;;
        } else {
            $whereDetails .= &quot; AND $key = :$key&quot;;
        }
        $i++;
    }
    $whereDetails = ltrim($whereDetails, ' AND ');
    $stmt = $this-&gt;prepare(&quot;UPDATE $table SET $fieldDetails WHERE $whereDetails&quot;);
    foreach ($data as $key =&gt; $value) {
        $stmt-&gt;bindValue(&quot;:$key&quot;, $value);
    }
    foreach ($where as $key =&gt; $value) {
        $stmt-&gt;bindValue(&quot;:$key&quot;, $value);
    }
    $stmt-&gt;execute();
    return $stmt-&gt;rowCount();
}
</code></pre>
<p>Call parameters here are the same as with insert with the addition of where parameter, because we need to specify which row we wnat to update. For example, use of update function would look like this:</p>
<pre><code class="language-php">$data = array(
    'firstName' =&gt; 'Joe',
    'lastnName' =&gt; 'Smith',
    'email' =&gt; 'someone@domain.com'
);
$where = array('memberID' =&gt; 2);
$db-&gt;update('users', $data, $where);
</code></pre>
<p>Now delete() method is somewhat similar to the update() but instead of <em>data</em> parametere we have <em>limit</em></p>
<pre><code class="language-php">public function delete($table, $where, $limit = 1)
{
    ksort($where);
    $whereDetails = null;
    $i = 0;
    foreach ($where as $key =&gt; $value) {
        if ($i == 0) {
            $whereDetails .= &quot;$key = :$key&quot;;
        } else {
            $whereDetails .= &quot; AND $key = :$key&quot;;
        }
        $i++;
    }
    $whereDetails = ltrim($whereDetails, ' AND ');
    if (is_numeric($limit)) {
        $uselimit = &quot;LIMIT $limit&quot;;
    }
    $stmt = $this-&gt;prepare(&quot;DELETE FROM $table WHERE $whereDetails $uselimit&quot;);
    foreach ($where as $key =&gt; $value) {
        $stmt-&gt;bindValue(&quot;:$key&quot;, $value);
    }
    $stmt-&gt;execute();
    return $stmt-&gt;rowCount();
}
</code></pre>
<p>This should cover most use cases, but somtimes we will need a little more flexibility with generating statements. For those cases we can also add this method:</p>
<pre><code class="language-php">//only use this if you know what you are doing
public function raw($sql)
{
    return $this-&gt;query($sql);
}
</code></pre>
<p>Now we can integrate our DB helper with the rest of the framework by calling it in our core model class, so let's open <code>/application/core/Model.php</code></p>
<pre><code class="language-php">&lt;?php

namespace application\core;


use application\helpers\DB;
use application\helpers\Request;

abstract class Model 
{	
	protected $request;
	protected $db;

    protected static $_table = '';
    protected static $_primaryKey = '';

    protected $columns;

	public function __construct() 
	{
		$this-&gt;request = new Request;
        $this-&gt;db = DB::connect();

        $this-&gt;columns = [];
	}
}
</code></pre>
<p>Now it looks a little more like a legit model class. Now when you create new models by extending this class, you will automagically be connected to the database, you just need to specify base table and primary. Let's add basic crud functions to our core model as well.</p>
<pre><code class="language-php">protected function populate($object)
{
    foreach ($object as $key =&gt; $value) {
        $this-&gt;set($key, $value);
    }
}

public function set($column,$value)
{
    $this-&gt;columns[$column] = $value;
}

public function get($column)
{
    return $this-&gt;columns[$column];
}

public function create()
{
    return $this-&gt;db-&gt;insert(static::$_table, $this-&gt;columns);
}

public function update($where = NULL)
{

    return $this-&gt;db-&gt;update(static::$_table, $this-&gt;columns, $where);
}

public function save($where = NULL)
{
    if($where || $this-&gt;get(static::$_primaryKey) !== null) $this-&gt;db-&gt;update(static::$_table, $this-&gt;columns, ($where)?$where:[static::$_primaryKey=&gt;$this-&gt;get(static::$_primaryKey)]);
    else $this-&gt;db-&gt;insert(static::$_table, $this-&gt;columns);
    return $this;
}

public static function delete($value){
    return DB::connect()-&gt;delete(static::$_table, [static::$_primaryKey =&gt; $value]);
}

public static function purge()
{
    return DB::connect()-&gt;truncate(static::$_table);
}

public static function getAll($condition=array(),$order=NULL,$startIndex=NULL,$count=NULL,$group=NULL){
    $query = &quot;SELECT * FROM &quot; . static::$_table;
    if(!empty($condition)){
        $query .= &quot; WHERE &quot;;
        foreach ($condition as $key =&gt; $value) {
            $query .= $key . &quot;=:&quot;.$key.&quot; AND &quot;;
        }
    }
    $query = rtrim($query,' AND ');
    if($group){
        $query .= &quot; GROUP BY &quot; . $group;
    }
    if($order){
        $query .= &quot; ORDER BY &quot; . $order;
    }
    if($startIndex !== NULL){
        $query .= &quot; LIMIT &quot; . $startIndex;
        if($count){
            $query .= &quot;,&quot; . $count;
        }
    }
    foreach ($condition as $key =&gt; $value) {
        $condition[':'.$key] = $value;
        unset($condition[$key]);
    }

    return DB::connect()-&gt;select($query,$condition);
}

public static function findOne($value){

    $sql = &quot;SELECT * FROM &quot; . static::$_table . &quot; WHERE &quot; . static::$_primaryKey . &quot; = :&quot; . static::$_primaryKey;
    $params = [ &quot;:&quot; . static::$_primaryKey =&gt; $value];

    $result = DB::connect()-&gt;find($sql, $params);
    return $result;
}

public static function getCount(){
    return DB::connect()-&gt;count(static::$_table);
}
</code></pre>
<p>And now we have very flexible base model with database support. </p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="chapter_6.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="chapter_8.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="chapter_6.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="chapter_8.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
