<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Cookies and sessions</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">1.</strong> Intro</a></li><li class="chapter-item expanded "><a href="chapter_2.html"><strong aria-hidden="true">2.</strong> Structure</a></li><li class="chapter-item expanded "><a href="chapter_3.html"><strong aria-hidden="true">3.</strong> Bare bones</a></li><li class="chapter-item expanded "><a href="chapter_4.html"><strong aria-hidden="true">4.</strong> First app</a></li><li class="chapter-item expanded "><a href="chapter_5.html"><strong aria-hidden="true">5.</strong> Basic security</a></li><li class="chapter-item expanded "><a href="chapter_6.html" class="active"><strong aria-hidden="true">6.</strong> Cookies and sessions</a></li><li class="chapter-item expanded "><a href="chapter_7.html"><strong aria-hidden="true">7.</strong> Database</a></li><li class="chapter-item expanded "><a href="chapter_8.html"><strong aria-hidden="true">8.</strong> Recap</a></li><li class="chapter-item expanded "><a href="chapter_9.html"><strong aria-hidden="true">9.</strong> File handling</a></li><li class="chapter-item expanded "><a href="chapter_10.html"><strong aria-hidden="true">10.</strong> Localization</a></li><li class="chapter-item expanded "><a href="chapter_11.html"><strong aria-hidden="true">11.</strong> Templating</a></li><li class="chapter-item expanded "><a href="chapter_12.html"><strong aria-hidden="true">12.</strong> Second App</a></li><li class="chapter-item expanded "><a href="chapter_13.html"><strong aria-hidden="true">13.</strong> Emails</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#chapter-6---cookies-and-sessions" id="chapter-6---cookies-and-sessions">Chapter 6 - Cookies and sessions</a></h1>
<p>When we created CSRF helper in the last chapter we briefly mentioned that we'll need to tighten the security of our sessions. So now we will do just that. First we need to define three new variables in our config.php file</p>
<pre><code class="language-php">define('SESSION_PATH', ROOT_PATH . 'application/storage/sessions/');
define('SESSION_KEY', 'randomstringofcharacters');
define('SESSION_TTL', 60);
</code></pre>
<p>Now create a new file named &quot;SecureSession.php&quot; inside the <code>/application/helpers/</code> folder.</p>
<pre><code class="language-php">&lt;?php

namespace application\helpers;


use SessionHandler;

class SecureSession extends SessionHandler
{

    protected $key, $name, $cookie;

    public function __construct($key = SESSION_KEY, $name = 'SESSION')
    {
        $this-&gt;key = $key;
        $this-&gt;name = $name;
        if(!isset($_SESSION)) {
            $this-&gt;setup();
        }
    }
    
    protected function setup()
    {
		ini_set('session.use_cookies', 1);
		ini_set('session.use_only_cookies', 1);

        session_name($this-&gt;name);
    }
}
</code></pre>
<p>It's also a good idea to have a session encrypted so lets also add that</p>
<pre><code class="language-php">private function _encrypt($data, $key) {
    $encryption_key = base64_decode($key);
    $iv = openssl_random_pseudo_bytes(openssl_cipher_iv_length('aes-256-cbc'));
    if($iv===false) die('Fatal error: encryption was not successful - could not save data!!'); // weak encryption

    $encrypted = openssl_encrypt($data, 'aes-256-cbc', $encryption_key, 0, $iv);
    return base64_encode($encrypted . '::' . $iv);
}

private function _decrypt($data, $key) {
    $encryption_key = base64_decode($key);
    list($encrypted_data, $iv) = explode('::', base64_decode($data), 2);
    return openssl_decrypt($encrypted_data, 'aes-256-cbc', $encryption_key, 0, $iv);
}

//and abstract it
public function _read($id)
{
    return $this-&gt;_decrypt(parent::read($id), $this-&gt;key);
}

public function _write($id, $data)
{
    return parent::write($id, $this-&gt;_encrypt($data, $this-&gt;key));
}
</code></pre>
<p>Now we can add the ussual session functionality</p>
<pre><code class="language-php">public function start()
{
    if (session_id() === '') {
        session_start();
        return (mt_rand(0, 4) === 0) ? $this-&gt;refresh() : true; // 1/5
    }

    return false;
}

public function forget()
{
    if (session_id() === '') {
        return false;
    }

    $_SESSION = [];

    return session_destroy();
}

public function refresh()
{
    return session_regenerate_id(true);
}
</code></pre>
<p>We should also have some method for validating sessions</p>
<pre><code class="language-php">public function isExpired($ttl = SESSION_TTL)
{
    $activity = isset($_SESSION['_last_activity'])
        ? $_SESSION['_last_activity']
        : false;

    if ($activity !== false &amp;&amp; time() - $activity &gt; $ttl * 60) {
        return true;
    }

    $_SESSION['_last_activity'] = time();

    return false;
}

public function isFingerprint()
{
    $hash = md5(
        $_SERVER['HTTP_USER_AGENT'] .
        (ip2long($_SERVER['REMOTE_ADDR']) &amp; ip2long('255.255.0.0'))
    );

    if (isset($_SESSION['_fingerprint'])) {
        return $_SESSION['_fingerprint'] === $hash;
    }

    $_SESSION['_fingerprint'] = $hash;

    return true;
}

//and abstarct it
public function isValid($ttl = SESSION_TTL)
{
    return ! $this-&gt;isExpired($ttl) &amp;&amp; $this-&gt;isFingerprint();
}
</code></pre>
<p>And final two methods are for getting and setting values from the session</p>
<pre><code class="language-php">public function get($name)
{
    $parsed = explode('.', $name);

    $result = $_SESSION;

    while ($parsed) {
        $next = array_shift($parsed);

        if (isset($result[$next])) {
            $result = $result[$next];
        } else {
            return null;
        }
    }

    return $result;
}

public function put($name, $value)
{
    $parsed = explode('.', $name);

    $session =&amp; $_SESSION;

    while (count($parsed) &gt; 1) {
        $next = array_shift($parsed);

        if ( ! isset($session[$next]) || ! is_array($session[$next])) {
            $session[$next] = [];
        }

        $session =&amp; $session[$next];
    }

    $session[array_shift($parsed)] = $value;
}
</code></pre>
<p>That's it we now have are secured session system. Now edit our CSRF helper to look like this:</p>
<pre><code class="language-php">&lt;?php

namespace application\helpers;


use Request;

class CSRF
{
    public static $name = '_CSRF';

    public function __construct()
    {
        $this-&gt;session = new SecureSession();
        $this-&gt;session-&gt;start();
    }

    public function insert($form = 'default')
    {
        echo '&lt;input type=&quot;hidden&quot; name=&quot;csrf_token&quot; value=&quot;' . $this-&gt;generate($form) . '&quot;&gt;';
    }


    public function generate($form = NULL)
    {
        $token = self::token() . self::fingerprint();
        $this-&gt;session-&gt;put(self::$name . '_' . $form,  $token);
        return $token;
    }

    public function check($token, $form = NULL)
    {
        if ($this-&gt;session-&gt;get(self::$name . '_' . $form) &amp;&amp; $this-&gt;session-&gt;get(self::$name . '_' . $form) === $token) { // token OK
            return (substr($token, -32) === self::fingerprint()); // fingerprint OK?
        }
        return FALSE;
    }

    protected static function token()
    {
        mt_srand((double) microtime() * 10000);
        $charid = strtoupper(md5(uniqid(rand(), TRUE)));
        return substr($charid, 0, 8) .
               substr($charid, 8, 4) .
               substr($charid, 12, 4) .
               substr($charid, 16, 4) .
               substr($charid, 20, 12);
    }

    protected static function fingerprint()
    {
        return strtoupper(md5(implode('|', array(Request::server('REMOTE_ADDR'), Request::server('HTTP_USER_AGENT')))));
    }
}
</code></pre>
<p>Now that we have done that we need to ensure that session will be started when website is opened. To do that we will need to create folder named &quot;middleware&quot; in <code>/application/</code> directory and inside create the file &quot;Persister.php&quot;</p>
<pre><code class="language-php">&lt;?php

namespace application\middleware;


use application\helpers\SecureSession;

class Persister
{
    public static $session;

    public static function run()
    {
        $session = new SecureSession(SESSION_KEY, 'PHPSESSID');

        ini_set('session.save_handler', 'files');
        session_set_save_handler($session, true);
        session_save_path(SESSION_PATH);

        $session-&gt;start();
    }
}
</code></pre>
<p>Now we need to register middleware in the core, so let's create Middleware.php inside <code>/application/core/</code> and write this:</p>
<pre><code class="language-php">&lt;?php

namespace application\core;


use application\middleware\Persister;

class Middleware
{
    public static function persist()
    {
        Persister::run();
    }
}
</code></pre>
<p>And finally we need to call th middleware in our root index.php file so change it's contents to the following</p>
<pre><code class="language-php">&lt;?php

use application\core\Router;
use application\core\Middleware;

define('ROOT_PATH', __DIR__. '/');
require_once ROOT_PATH . 'application/config/config.php';

spl_autoload_register(function($class) {
    $path = str_replace('\\', '/', $class.'.php');
    if (file_exists($path)) {
        require $path;
    }
});

if(ENVIRONMENT === 'dev') {
	//debugger handler
}elseif(ENVIRONMENT === 'prod'){
    error_reporting(0);
    ini_set('display_errors', 0);
}else{
    die('Fatal error: environment not defined or valid!');
}

Middleware::persist(); 

$router = new Router;
$router-&gt;run();

</code></pre>
<p>That's it sessions are up and running. Next up are cookies so create <code>/application/helper/Cookies.php</code></p>
<pre><code class="language-php">&lt;?php

namespace application\helpers;


use Request;

class Cookies
{

    public $name;
    public $value = '';
    public $expires;
    public $path = '/';
    public $domain = '';
    public $secure = false;
    public $http_only = false;


    public function __construct($name, $value = null)
    {
        $this-&gt;name = $name;
        $this-&gt;domain = '.' .Request::server('SERVER_NAME');

        if (Request::server('HTTPS') &amp;&amp; Request::server('HTTPS') !== 'off') {
            $this-&gt;secure = true;
        }

        if ($value !== null) {
            $this-&gt;value = $value;
        }
    }
}
</code></pre>
<p>As cookies have expiry date we can create some functions that will make it easier to configure</p>
<pre><code class="language-php">public function expires_in($time, $unit = &quot;months&quot;)
{
    if (!empty($time)) {
        switch ($unit) {
            case 'months' :
                $time = $time * 60 * 60 * 24 * 31;
                break;
            case 'days'   :
                $time = $time * 60 * 60 * 24;
                break;
            case 'hours'  :
                $time = $time * 60 * 60;
                break;
            case 'minutes':
                $time *= 60;
                break;
        }
    }
    $this-&gt;expires_at($time);
}

public function expires_at($time)
{
    if (empty($time)) {
        $time = null;
    }
    $this-&gt;expires = $time;
}
</code></pre>
<p>And while we are abstarcting, we might as well add methods for reading and writing to a cookie</p>
<pre><code class="language-php">public function set()
{
    return setcookie(
        $this-&gt;name,
        $this-&gt;value,
        $this-&gt;expires,
        $this-&gt;path,
        $this-&gt;domain,
        $this-&gt;secure,
        $this-&gt;http_only
    );
}

public function get()
{
    return ($this-&gt;value === '' &amp;&amp; isset($_COOKIE[$this-&gt;name])) ? $_COOKIE[$this-&gt;name] : $this-&gt;value;
}

public function delete()
{
    $this-&gt;value = '';
    $this-&gt;expires = time() - 3600;
    return $this-&gt;set();
}
</code></pre>
<p>And that's the whole cookie class. We can now add it to our middleware if we need. Actually let's do that. Open up the <code>/application/middleware/Persister.php</code> and edit it like this:</p>
<pre><code class="language-php">&lt;?php

namespace application\middleware;


use application\helpers\SecureSession;
use application\helpers\Cookies;

class Persister
{
    public static $session;
    public static $cookies;

    public static function run()
    {
        $session = new SecureSession(SESSION_KEY, 'PHPSESSID');

        $cookies = new Cookies('SESSION_COOKIE');
        $cookies-&gt;expires = 0;
        $cookies-&gt;value = 'TRUE';
        $cookies-&gt;set();

        ini_set('session.save_handler', 'files');
        session_set_save_handler($session, true);
        session_save_path(SESSION_PATH);

        $session-&gt;start();
    }
}
</code></pre>
<p>So now we have session cookie stored on on browser of the user who visits our webpage.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="chapter_5.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="chapter_7.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="chapter_5.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="chapter_7.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
